datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  GESTOR
  ALMOXARIFE
  TECNICO_SST
  SUPERVISOR
  COLABORADOR
}

enum ItemType {
  FERRAMENTA
  EPI
  EPC
  CONSUMIVEL
}

enum Unit {
  UN
  PAR
  CX
}

enum ItemStatus {
  ATIVO
  INATIVO
}

enum MovementType {
  ENTRADA
  ENTREGA
  DEVOLUCAO
  TRANSFERENCIA
  AJUSTE
  BAIXA
}

enum ReservationStatus {
  RESERVADO
  SEPARADO
  CANCELADO
  CONSUMIDO
}

enum ReservationReferenceType {
  ATIVIDADE_EXECUCAO
  OS
  MANUAL
}

enum AssetCondition {
  OK
  MANUTENCAO
  PERDIDO
  BAIXADO
}

enum TrainingStatus {
  VALIDO
  VENCIDO
  PENDENTE
}

enum InspectionStatus {
  OK
  NAO_CONFORME
}

enum NonConformityStatus {
  ABERTA
  EM_ANDAMENTO
  RESOLVIDA
  CANCELADA
}

enum IncidentSeverity {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

enum OriginType {
  INSPECAO
  OBSERVACAO
  INCIDENTE
}

enum AprStatus {
  RASCUNHO
  EM_ANALISE
  APROVADA
}

enum PermitType {
  ALTURA
  QUENTE
  ESPACO_CONFINADO
  ELETRICA
}

enum PermitStatus {
  ABERTA
  APROVADA
  ENCERRADA
}

enum ChecklistQuestionType {
  BOOLEAN
  TEXT
  SCORE
  SELECT
}

enum ActionPlanStatus {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDA
  VERIFICADA
}

enum IncidentStatus {
  ABERTO
  INVESTIGACAO
  ENCERRADO
}

enum PermitApprovalStatus {
  PENDENTE
  APROVADO
  REPROVADO
}

enum SstAlertStatus {
  ABERTO
  RESOLVIDO
}

enum SstAlertSeverity {
  INFO
  ATENCAO
  CRITICA
}

enum SstAlertType {
  TREINAMENTO_VENCER
  TREINAMENTO_VENCIDO
  INSPECAO_ATRASADA
  NC_VENCENDO
  NC_VENCIDA
  PT_VENCER
  PT_VENCIDA
}

enum DocumentReviewStatus {
  PENDENTE
  APROVADO
  REPROVADO
}

model User {
  id           String           @id @default(uuid())
  name         String
  email        String           @unique
  passwordHash String
  role         Role
  active       Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  movementsCreated Movement[]  @relation("movement_creator")
  movementsApproved Movement[] @relation("movement_approver")
  movementsAsCollaborator Movement[] @relation("movement_collaborator")
  reservationsCreated Reservation[] @relation("reservation_creator")
  responsibilityTerms ResponsibilityTerm[] @relation("term_collaborator")
  training     TrainingRecord[]
  inspectionRuns  InspectionRun[] @relation("inspection_performer")
  nonConformitiesResponsible NonConformity[] @relation("nc_responsible")
  nonConformitiesCreated NonConformity[] @relation("nc_created")
  nonConformitiesVerified NonConformity[] @relation("nc_verified")
  actionPlanItems ActionPlanItem[] @relation("action_responsible")
  permitApprovals PermitApproval[] @relation("permit_approver")
  permitCollaborations PermitCollaborator[]
  documentationResponsible ActivityDocumentation[] @relation("doc_responsible")
  documentationReviewed ActivityDocumentation[] @relation("doc_reviewer")
  notifications UserNotification[]
  auditLogs    AuditLog[]
}

model Project {
  id          String      @id @default(uuid())
  name        String
  code        String?
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  worksites   Worksite[]
  stockBalances StockBalance[]
  batches    InventoryBatch[]
  movementsOrigin Movement[] @relation("movement_origin_project")
  movementsDestination Movement[] @relation("movement_dest_project")
  reservations Reservation[]
  trainings   Training[]
  trainingRequirements TrainingRequirementByRole[]
  checklistTemplates ChecklistTemplate[]
  inspectionRuns InspectionRun[]
  nonConformities NonConformity[]
  incidents   Incident[]
  aprs        Apr[]
  permits     PermitToWork[]
  sstAlerts   SstAlert[]
  documentations ActivityDocumentation[]
}

model Worksite {
  id          String      @id @default(uuid())
  projectId   String
  name        String
  address     String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  project     Project     @relation(fields: [projectId], references: [id])
  stockBalances StockBalance[]
  batches    InventoryBatch[]
  movementsOrigin Movement[] @relation("movement_origin_worksite")
  movementsDestination Movement[] @relation("movement_dest_worksite")
  reservations Reservation[]
  inspectionRuns InspectionRun[]
  nonConformities NonConformity[]
  incidents   Incident[]
  aprs        Apr[]
  permits     PermitToWork[]
  documentations ActivityDocumentation[]

  @@index([projectId])
}

model Activity {
  id        String   @id @default(uuid())
  projectId String
  name      String
  scheduledAt DateTime?
  project   Project @relation(fields: [projectId], references: [id])
  documentations ActivityDocumentation[]
}

model InventoryItem {
  id            String    @id @default(uuid())
  type          ItemType
  name          String
  description   String?
  brand         String?
  model         String?
  unit          Unit
  internalCode  String?
  barcode       String?
  status        ItemStatus @default(ATIVO)
  caNumber      String?
  caValidUntil  DateTime?
  itemValidUntil DateTime?
  sizes         Json?
  deletedAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  photos        ItemPhoto[]
  batches       InventoryBatch[]
  balances      StockBalance[]
  movements     Movement[]
  reservations  Reservation[]
  assets        ItemAsset[]
  kitItems      KitItem[]

  @@index([name])
  @@index([type])
}

model ItemPhoto {
  id        String         @id @default(uuid())
  itemId    String
  url       String
  item      InventoryItem @relation(fields: [itemId], references: [id])
}

model InventoryBatch {
  id            String   @id @default(uuid())
  itemId        String
  projectId     String
  worksiteId    String?
  batchCode     String
  itemValidUntil DateTime?
  caValidUntil  DateTime?
  unitCost      Float?
  createdAt     DateTime @default(now())
  item          InventoryItem @relation(fields: [itemId], references: [id])
  project       Project  @relation(fields: [projectId], references: [id])
  worksite      Worksite? @relation(fields: [worksiteId], references: [id])
  balances      StockBalance[]
  movements     Movement[]
  assets        ItemAsset[]

  @@index([itemId])
  @@index([projectId])
  @@unique([itemId, projectId, worksiteId, batchCode])
}

model StockBalance {
  id           String   @id @default(uuid())
  itemId       String
  projectId    String
  worksiteId   String?
  batchId      String?
  qtyAvailable Int      @default(0)
  qtyReserved  Int      @default(0)
  minQuantity  Int      @default(0)
  reorderPoint Int      @default(0)
  updatedAt    DateTime @updatedAt
  item         InventoryItem @relation(fields: [itemId], references: [id])
  project      Project  @relation(fields: [projectId], references: [id])
  worksite     Worksite? @relation(fields: [worksiteId], references: [id])
  batch        InventoryBatch? @relation(fields: [batchId], references: [id])

  @@unique([itemId, projectId, worksiteId, batchId])
  @@index([projectId])
  @@index([itemId])
  @@index([batchId])
}

model Movement {
  id                   String       @id @default(uuid())
  type                 MovementType
  itemId               String
  batchId              String?
  qty                  Int
  projectOriginId      String?
  worksiteOriginId     String?
  projectDestinationId String?
  worksiteDestinationId String?
  collaboratorId       String?
  reservationId        String?
  relatedMovementId    String?
  reason               String?
  notes                String?
  invoiceNumber        String?
  createdById          String
  approvedById         String?
  createdAt            DateTime     @default(now())
  item                 InventoryItem @relation(fields: [itemId], references: [id])
  batch                InventoryBatch? @relation(fields: [batchId], references: [id])
  projectOrigin        Project?      @relation("movement_origin_project", fields: [projectOriginId], references: [id])
  projectDestination   Project?      @relation("movement_dest_project", fields: [projectDestinationId], references: [id])
  worksiteOrigin       Worksite?     @relation("movement_origin_worksite", fields: [worksiteOriginId], references: [id])
  worksiteDestination  Worksite?     @relation("movement_dest_worksite", fields: [worksiteDestinationId], references: [id])
  collaborator         User?         @relation("movement_collaborator", fields: [collaboratorId], references: [id])
  createdBy            User          @relation("movement_creator", fields: [createdById], references: [id])
  approvedBy           User?         @relation("movement_approver", fields: [approvedById], references: [id])
  relatedMovement      Movement?     @relation("movement_related", fields: [relatedMovementId], references: [id])
  relatedTo            Movement[]    @relation("movement_related")
  attachments          MovementAttachment[]
  responsibilityTerm   ResponsibilityTerm?
  reservation          Reservation?  @relation(fields: [reservationId], references: [id])

  @@index([projectOriginId])
  @@index([projectDestinationId])
  @@index([itemId])
  @@index([collaboratorId])
}

model MovementAttachment {
  id         String    @id @default(uuid())
  movementId String
  name       String
  url        String
  type       String?
  movement   Movement @relation(fields: [movementId], references: [id])
}

model Reservation {
  id            String   @id @default(uuid())
  projectId     String
  worksiteId    String?
  itemId        String
  batchId       String?
  qty           Int
  status        ReservationStatus
  referenceType ReservationReferenceType?
  referenceId   String?
  notes         String?
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  item          InventoryItem @relation(fields: [itemId], references: [id])
  batch         InventoryBatch? @relation(fields: [batchId], references: [id])
  project       Project  @relation(fields: [projectId], references: [id])
  worksite      Worksite? @relation(fields: [worksiteId], references: [id])
  createdBy     User     @relation("reservation_creator", fields: [createdById], references: [id])
  movements     Movement[]

  @@index([projectId])
  @@index([itemId])
}

model ResponsibilityTerm {
  id             String   @id @default(uuid())
  movementId     String   @unique
  collaboratorId String
  pdfData        Bytes
  fileName       String?
  acceptedAt     DateTime?
  acceptedByName String?
  acceptedByCpf  String?
  signatureData  Json?
  createdAt      DateTime @default(now())
  movement       Movement @relation(fields: [movementId], references: [id])
  collaborator   User     @relation("term_collaborator", fields: [collaboratorId], references: [id])
}

model ItemAsset {
  id             String   @id @default(uuid())
  itemId         String
  batchId        String?
  serialNumber   String?
  patrimonyCode  String?
  condition      AssetCondition @default(OK)
  lastInspectionAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  item           InventoryItem @relation(fields: [itemId], references: [id])
  batch          InventoryBatch? @relation(fields: [batchId], references: [id])

  @@index([itemId])
  @@index([batchId])
}

model Kit {
  id          String   @id @default(uuid())
  name        String
  description String?
  roleName    String?
  createdAt   DateTime @default(now())
  items       KitItem[]
}

model KitItem {
  id       String         @id @default(uuid())
  kitId    String
  itemId   String
  quantity Int
  required Boolean @default(true)
  kit      Kit    @relation(fields: [kitId], references: [id])
  item     InventoryItem @relation(fields: [itemId], references: [id])

  @@unique([kitId, itemId])
}

model Training {
  id             String   @id @default(uuid())
  name           String
  nr             String?
  hours          Int
  validityDays   Int
  projectId      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  records        TrainingRecord[]
  requirements   TrainingRequirementByRole[]
  project        Project? @relation(fields: [projectId], references: [id])
}

model TrainingRequirementByRole {
  id          String   @id @default(uuid())
  trainingId  String
  role        Role
  projectId   String?
  mandatory   Boolean @default(true)
  createdAt   DateTime @default(now())
  training    Training @relation(fields: [trainingId], references: [id])
  project     Project? @relation(fields: [projectId], references: [id])

  @@unique([trainingId, role, projectId])
  @@index([role])
}

model TrainingRecord {
  id            String         @id @default(uuid())
  trainingId    String
  userId        String
  date          DateTime
  validUntil    DateTime
  status        TrainingStatus
  certificateUrl String?
  projectId     String?
  createdAt     DateTime @default(now())
  training      Training @relation(fields: [trainingId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  project       Project? @relation(fields: [projectId], references: [id])

  @@index([userId])
}

model ChecklistTemplate {
  id              String   @id @default(uuid())
  type            String
  title           String
  periodicityDays Int
  projectId       String?
  worksiteId      String?
  active          Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  questions       ChecklistQuestion[]
  runs            InspectionRun[]
  project         Project? @relation(fields: [projectId], references: [id])
  worksite        Worksite? @relation(fields: [worksiteId], references: [id])

  @@index([projectId])
}

model ChecklistQuestion {
  id               String   @id @default(uuid())
  templateId       String
  order            Int
  text             String
  type             ChecklistQuestionType
  required         Boolean @default(true)
  options          Json?
  weight           Int?
  requiresPhotoOnFail Boolean @default(false)
  createdAt        DateTime @default(now())
  template         ChecklistTemplate @relation(fields: [templateId], references: [id])

  @@index([templateId])
}

model InspectionRun {
  id            String   @id @default(uuid())
  templateId    String
  projectId     String
  worksiteId    String?
  performedById String
  performedAt   DateTime
  status        InspectionStatus
  answers       Json
  evidenceUrls  Json?
  geo           Json?
  createdAt     DateTime @default(now())
  template      ChecklistTemplate @relation(fields: [templateId], references: [id])
  project       Project @relation(fields: [projectId], references: [id])
  worksite      Worksite? @relation(fields: [worksiteId], references: [id])
  performedBy   User @relation("inspection_performer", fields: [performedById], references: [id])
  nonConformity NonConformity?

  @@index([projectId])
  @@index([templateId])
}

model NonConformity {
  id            String   @id @default(uuid())
  originType    OriginType
  inspectionId  String?
  incidentId    String?
  projectId     String?
  worksiteId    String?
  severity      IncidentSeverity
  title         String?
  description   String
  evidenceUrls  Json?
  responsibleId String
  dueDate       DateTime
  status        NonConformityStatus
  createdAt     DateTime @default(now())
  createdById   String
  closedAt      DateTime?
  verifiedById  String?
  verifiedAt    DateTime?
  actionItems   ActionPlanItem[]
  inspection    InspectionRun? @relation(fields: [inspectionId], references: [id])
  incident      Incident? @relation(fields: [incidentId], references: [id])
  project       Project? @relation(fields: [projectId], references: [id])
  worksite      Worksite? @relation(fields: [worksiteId], references: [id])
  responsible   User     @relation("nc_responsible", fields: [responsibleId], references: [id])
  createdBy     User     @relation("nc_created", fields: [createdById], references: [id])
  verifiedBy    User?    @relation("nc_verified", fields: [verifiedById], references: [id])

  @@index([status])
  @@index([projectId])
}

model ActionPlanItem {
  id              String   @id @default(uuid())
  nonConformityId String
  title           String
  description     String?
  responsibleId   String
  dueDate         DateTime
  status          ActionPlanStatus
  evidenceUrls    Json?
  completedAt     DateTime?
  verifiedAt      DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  nonConformity   NonConformity @relation(fields: [nonConformityId], references: [id])
  responsible     User     @relation("action_responsible", fields: [responsibleId], references: [id])

  @@index([nonConformityId])
  @@index([status])
}

model Incident {
  id          String   @id @default(uuid())
  projectId   String
  worksiteId  String?
  date        DateTime
  severity    IncidentSeverity
  status      IncidentStatus @default(ABERTO)
  description String
  category    String
  photos      Json?
  createdById String
  createdAt   DateTime @default(now())
  project     Project @relation(fields: [projectId], references: [id])
  worksite    Worksite? @relation(fields: [worksiteId], references: [id])
  createdBy   User     @relation(fields: [createdById], references: [id])
  involved    IncidentInvolved[]
  nonConformities NonConformity[]
  investigation IncidentInvestigation?

  @@index([projectId])
}

model IncidentInvolved {
  id         String @id @default(uuid())
  incidentId String
  userId     String
  incident   Incident @relation(fields: [incidentId], references: [id])
  user       User @relation(fields: [userId], references: [id])

  @@unique([incidentId, userId])
}

model IncidentInvestigation {
  id              String   @id @default(uuid())
  incidentId      String   @unique
  fiveWhys        Json
  rootCause       String?
  immediateActions Json?
  correctiveActions Json?
  preventiveActions Json?
  effectivenessCheck String?
  verifiedById    String?
  verifiedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  incident        Incident @relation(fields: [incidentId], references: [id])
  verifiedBy      User?    @relation(fields: [verifiedById], references: [id])
}

model AprTemplate {
  id               String   @id @default(uuid())
  name             String
  activity         String
  hazards          Json
  risks            Json
  controls         Json
  requiredTrainings Json?
  requiredEpis     Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  aprs             Apr[]
}

model Apr {
  id          String   @id @default(uuid())
  projectId   String
  worksiteId  String?
  templateId  String?
  activity    String
  hazards     Json
  risks       Json
  controls    Json
  approvedById String?
  status      AprStatus
  createdAt   DateTime @default(now())
  project     Project @relation(fields: [projectId], references: [id])
  worksite    Worksite? @relation(fields: [worksiteId], references: [id])
  template    AprTemplate? @relation(fields: [templateId], references: [id])
  permits     PermitToWork[]
}

model PermitToWork {
  id          String   @id @default(uuid())
  aprId       String
  projectId   String?
  worksiteId  String?
  type        PermitType
  requirements Json
  validFrom   DateTime
  validTo     DateTime
  status      PermitStatus
  createdAt   DateTime @default(now())
  apr         Apr @relation(fields: [aprId], references: [id])
  project     Project? @relation(fields: [projectId], references: [id])
  worksite    Worksite? @relation(fields: [worksiteId], references: [id])
  approvals   PermitApproval[]
  collaborators PermitCollaborator[]

  @@index([projectId])
}

model PermitApproval {
  id        String   @id @default(uuid())
  permitId  String
  userId    String
  status    PermitApprovalStatus
  notes     String?
  createdAt DateTime @default(now())
  permit    PermitToWork @relation(fields: [permitId], references: [id])
  user      User     @relation("permit_approver", fields: [userId], references: [id])

  @@unique([permitId, userId])
}

model PermitCollaborator {
  id        String @id @default(uuid())
  permitId  String
  userId    String
  permit    PermitToWork @relation(fields: [permitId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([permitId, userId])
}

model SstAlert {
  id         String   @id @default(uuid())
  projectId  String?
  type       SstAlertType
  severity   SstAlertSeverity
  title      String
  message    String
  dueDate    DateTime?
  entityType String?
  entityId   String?
  status     SstAlertStatus @default(ABERTO)
  createdAt  DateTime @default(now())
  readAt     DateTime?
  resolvedAt DateTime?
  project    Project? @relation(fields: [projectId], references: [id])

  @@index([status])
  @@index([projectId])
}

model ActivityDocumentation {
  id            String   @id @default(uuid())
  activityId    String?
  activityName  String
  projectId     String
  worksiteId    String?
  responsibleId String
  aprReference  String?
  aprFileUrl    String?
  status        DocumentReviewStatus @default(PENDENTE)
  reviewNotes   String?
  correctionInstructions String?
  reviewedAt    DateTime?
  reviewerId    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  activity      Activity? @relation(fields: [activityId], references: [id])
  project       Project  @relation(fields: [projectId], references: [id])
  worksite      Worksite? @relation(fields: [worksiteId], references: [id])
  responsible   User     @relation("doc_responsible", fields: [responsibleId], references: [id])
  reviewer      User?    @relation("doc_reviewer", fields: [reviewerId], references: [id])
  attachments   DocumentationAttachment[]

  @@index([projectId])
  @@index([status])
  @@index([responsibleId])
}

model DocumentationAttachment {
  id              String   @id @default(uuid())
  documentationId String
  name            String
  url             String
  type            String?
  documentation   ActivityDocumentation @relation(fields: [documentationId], references: [id])

  @@index([documentationId])
}

model UserNotification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  entityType String?
  entityId  String?
  readAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  before    Json?
  after     Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([entity])
}
