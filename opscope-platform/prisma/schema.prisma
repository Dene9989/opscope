datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  GESTOR
  ALMOXARIFE
  TECNICO_SST
  SUPERVISOR
  COLABORADOR
}

enum ItemType {
  FERRAMENTA
  EPI
  EPC
  CONSUMIVEL
}

enum Unit {
  UN
  PAR
  CX
}

enum ItemStatus {
  ATIVO
  INATIVO
}

enum MovementType {
  ENTRADA
  ENTREGA
  DEVOLUCAO
  TRANSFERENCIA
  AJUSTE
  BAIXA
}

enum ReservationStatus {
  RESERVADO
  SEPARADO
  CANCELADO
  CONSUMIDO
}

enum ReservationReferenceType {
  ATIVIDADE_EXECUCAO
  OS
  MANUAL
}

enum AssetCondition {
  OK
  MANUTENCAO
  PERDIDO
  BAIXADO
}

enum TrainingStatus {
  VALIDO
  VENCIDO
  PENDENTE
}

enum InspectionStatus {
  OK
  NAO_CONFORME
}

enum NonConformityStatus {
  ABERTA
  EM_ANDAMENTO
  RESOLVIDA
  CANCELADA
}

enum IncidentSeverity {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

enum OriginType {
  INSPECAO
  OBSERVACAO
  INCIDENTE
}

enum AprStatus {
  RASCUNHO
  EM_ANALISE
  APROVADA
}

enum PermitType {
  ALTURA
  QUENTE
  ESPACO_CONFINADO
  ELETRICA
}

enum PermitStatus {
  ABERTA
  APROVADA
  ENCERRADA
}

model User {
  id           String           @id @default(uuid())
  name         String
  email        String           @unique
  passwordHash String
  role         Role
  active       Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  movementsCreated Movement[]  @relation("movement_creator")
  movementsApproved Movement[] @relation("movement_approver")
  movementsAsCollaborator Movement[] @relation("movement_collaborator")
  reservationsCreated Reservation[] @relation("reservation_creator")
  responsibilityTerms ResponsibilityTerm[] @relation("term_collaborator")
  training     TrainingRecord[]
  inspections  InspectionExecution[] @relation("inspection_performer")
  auditLogs    AuditLog[]
}

model Project {
  id          String      @id @default(uuid())
  name        String
  code        String?
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  worksites   Worksite[]
  stockBalances StockBalance[]
  batches    InventoryBatch[]
  movementsOrigin Movement[] @relation("movement_origin_project")
  movementsDestination Movement[] @relation("movement_dest_project")
  reservations Reservation[]
  trainings   Training[]
  inspections InspectionExecution[]
  incidents   Incident[]
  aprs        Apr[]
}

model Worksite {
  id          String      @id @default(uuid())
  projectId   String
  name        String
  address     String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  project     Project     @relation(fields: [projectId], references: [id])
  stockBalances StockBalance[]
  batches    InventoryBatch[]
  movementsOrigin Movement[] @relation("movement_origin_worksite")
  movementsDestination Movement[] @relation("movement_dest_worksite")
  reservations Reservation[]
  inspections InspectionExecution[]
  incidents   Incident[]
  aprs        Apr[]

  @@index([projectId])
}

model Activity {
  id        String   @id @default(uuid())
  projectId String
  name      String
  scheduledAt DateTime?
  project   Project @relation(fields: [projectId], references: [id])
}

model InventoryItem {
  id            String    @id @default(uuid())
  type          ItemType
  name          String
  description   String?
  brand         String?
  model         String?
  unit          Unit
  internalCode  String?
  barcode       String?
  status        ItemStatus @default(ATIVO)
  caNumber      String?
  caValidUntil  DateTime?
  itemValidUntil DateTime?
  sizes         Json?
  deletedAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  photos        ItemPhoto[]
  batches       InventoryBatch[]
  balances      StockBalance[]
  movements     Movement[]
  reservations  Reservation[]
  assets        ItemAsset[]
  kitItems      KitItem[]

  @@index([name])
  @@index([type])
}

model ItemPhoto {
  id        String         @id @default(uuid())
  itemId    String
  url       String
  item      InventoryItem @relation(fields: [itemId], references: [id])
}

model InventoryBatch {
  id            String   @id @default(uuid())
  itemId        String
  projectId     String
  worksiteId    String?
  batchCode     String
  itemValidUntil DateTime?
  caValidUntil  DateTime?
  unitCost      Float?
  createdAt     DateTime @default(now())
  item          InventoryItem @relation(fields: [itemId], references: [id])
  project       Project  @relation(fields: [projectId], references: [id])
  worksite      Worksite? @relation(fields: [worksiteId], references: [id])
  balances      StockBalance[]
  movements     Movement[]
  assets        ItemAsset[]

  @@index([itemId])
  @@index([projectId])
  @@unique([itemId, projectId, worksiteId, batchCode])
}

model StockBalance {
  id           String   @id @default(uuid())
  itemId       String
  projectId    String
  worksiteId   String?
  batchId      String?
  qtyAvailable Int      @default(0)
  qtyReserved  Int      @default(0)
  minQuantity  Int      @default(0)
  reorderPoint Int      @default(0)
  updatedAt    DateTime @updatedAt
  item         InventoryItem @relation(fields: [itemId], references: [id])
  project      Project  @relation(fields: [projectId], references: [id])
  worksite     Worksite? @relation(fields: [worksiteId], references: [id])
  batch        InventoryBatch? @relation(fields: [batchId], references: [id])

  @@unique([itemId, projectId, worksiteId, batchId])
  @@index([projectId])
  @@index([itemId])
  @@index([batchId])
}

model Movement {
  id                   String       @id @default(uuid())
  type                 MovementType
  itemId               String
  batchId              String?
  qty                  Int
  projectOriginId      String?
  worksiteOriginId     String?
  projectDestinationId String?
  worksiteDestinationId String?
  collaboratorId       String?
  reservationId        String?
  relatedMovementId    String?
  reason               String?
  notes                String?
  invoiceNumber        String?
  createdById          String
  approvedById         String?
  createdAt            DateTime     @default(now())
  item                 InventoryItem @relation(fields: [itemId], references: [id])
  batch                InventoryBatch? @relation(fields: [batchId], references: [id])
  projectOrigin        Project?      @relation("movement_origin_project", fields: [projectOriginId], references: [id])
  projectDestination   Project?      @relation("movement_dest_project", fields: [projectDestinationId], references: [id])
  worksiteOrigin       Worksite?     @relation("movement_origin_worksite", fields: [worksiteOriginId], references: [id])
  worksiteDestination  Worksite?     @relation("movement_dest_worksite", fields: [worksiteDestinationId], references: [id])
  collaborator         User?         @relation("movement_collaborator", fields: [collaboratorId], references: [id])
  createdBy            User          @relation("movement_creator", fields: [createdById], references: [id])
  approvedBy           User?         @relation("movement_approver", fields: [approvedById], references: [id])
  relatedMovement      Movement?     @relation("movement_related", fields: [relatedMovementId], references: [id])
  relatedTo            Movement[]    @relation("movement_related")
  attachments          MovementAttachment[]
  responsibilityTerm   ResponsibilityTerm?
  reservation          Reservation?  @relation(fields: [reservationId], references: [id])

  @@index([projectOriginId])
  @@index([projectDestinationId])
  @@index([itemId])
  @@index([collaboratorId])
}

model MovementAttachment {
  id         String    @id @default(uuid())
  movementId String
  name       String
  url        String
  type       String?
  movement   Movement @relation(fields: [movementId], references: [id])
}

model Reservation {
  id            String   @id @default(uuid())
  projectId     String
  worksiteId    String?
  itemId        String
  batchId       String?
  qty           Int
  status        ReservationStatus
  referenceType ReservationReferenceType?
  referenceId   String?
  notes         String?
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  item          InventoryItem @relation(fields: [itemId], references: [id])
  batch         InventoryBatch? @relation(fields: [batchId], references: [id])
  project       Project  @relation(fields: [projectId], references: [id])
  worksite      Worksite? @relation(fields: [worksiteId], references: [id])
  createdBy     User     @relation("reservation_creator", fields: [createdById], references: [id])
  movements     Movement[]

  @@index([projectId])
  @@index([itemId])
}

model ResponsibilityTerm {
  id             String   @id @default(uuid())
  movementId     String   @unique
  collaboratorId String
  pdfData        Bytes
  fileName       String?
  acceptedAt     DateTime?
  acceptedByName String?
  acceptedByCpf  String?
  signatureData  Json?
  createdAt      DateTime @default(now())
  movement       Movement @relation(fields: [movementId], references: [id])
  collaborator   User     @relation("term_collaborator", fields: [collaboratorId], references: [id])
}

model ItemAsset {
  id             String   @id @default(uuid())
  itemId         String
  batchId        String?
  serialNumber   String?
  patrimonyCode  String?
  condition      AssetCondition @default(OK)
  lastInspectionAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  item           InventoryItem @relation(fields: [itemId], references: [id])
  batch          InventoryBatch? @relation(fields: [batchId], references: [id])

  @@index([itemId])
  @@index([batchId])
}

model Kit {
  id          String   @id @default(uuid())
  name        String
  description String?
  roleName    String?
  createdAt   DateTime @default(now())
  items       KitItem[]
}

model KitItem {
  id       String         @id @default(uuid())
  kitId    String
  itemId   String
  quantity Int
  required Boolean @default(true)
  kit      Kit    @relation(fields: [kitId], references: [id])
  item     InventoryItem @relation(fields: [itemId], references: [id])

  @@unique([kitId, itemId])
}

model Training {
  id             String   @id @default(uuid())
  name           String
  nr             String?
  hours          Int
  validityDays   Int
  mandatoryRoles Json?
  projectId      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  records        TrainingRecord[]
  project        Project? @relation(fields: [projectId], references: [id])
}

model TrainingRecord {
  id            String         @id @default(uuid())
  trainingId    String
  userId        String
  date          DateTime
  validUntil    DateTime
  status        TrainingStatus
  certificateUrl String?
  createdAt     DateTime @default(now())
  training      Training @relation(fields: [trainingId], references: [id])
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model InspectionTemplate {
  id              String   @id @default(uuid())
  type            String
  title           String
  periodicityDays Int
  projectId       String?
  worksiteId      String?
  questions       Json
  active          Boolean @default(true)
  createdAt       DateTime @default(now())
  executions      InspectionExecution[]
}

model InspectionExecution {
  id            String   @id @default(uuid())
  templateId    String
  projectId     String
  worksiteId    String?
  performedById String
  performedAt   DateTime
  answers       Json
  photos        Json?
  geo           Json?
  status        InspectionStatus
  createdAt     DateTime @default(now())
  template      InspectionTemplate @relation(fields: [templateId], references: [id])
  project       Project @relation(fields: [projectId], references: [id])
  worksite      Worksite? @relation(fields: [worksiteId], references: [id])
  performedBy   User @relation("inspection_performer", fields: [performedById], references: [id])
  nonConformity NonConformity?
}

model NonConformity {
  id            String   @id @default(uuid())
  originType    OriginType
  inspectionId  String?
  incidentId    String?
  severity      IncidentSeverity
  description   String
  evidenceUrls  Json?
  responsibleId String
  dueDate       DateTime
  status        NonConformityStatus
  createdAt     DateTime @default(now())
  createdById   String
  actionPlan    ActionPlan?
  inspection    InspectionExecution? @relation(fields: [inspectionId], references: [id])
  incident      Incident? @relation(fields: [incidentId], references: [id])
}

model ActionPlan {
  id               String   @id @default(uuid())
  nonConformityId  String   @unique
  actions          Json
  status           String
  createdAt        DateTime @default(now())
  nonConformity    NonConformity @relation(fields: [nonConformityId], references: [id])
}

model Incident {
  id          String   @id @default(uuid())
  projectId   String
  worksiteId  String?
  date        DateTime
  severity    IncidentSeverity
  description String
  category    String
  photos      Json?
  fiveWhys    Json?
  createdAt   DateTime @default(now())
  project     Project @relation(fields: [projectId], references: [id])
  worksite    Worksite? @relation(fields: [worksiteId], references: [id])
  involved    IncidentInvolved[]
  nonConformities NonConformity[]
}

model IncidentInvolved {
  id         String @id @default(uuid())
  incidentId String
  userId     String
  incident   Incident @relation(fields: [incidentId], references: [id])
  user       User @relation(fields: [userId], references: [id])

  @@unique([incidentId, userId])
}

model Apr {
  id          String   @id @default(uuid())
  projectId   String
  worksiteId  String?
  activity    String
  hazards     Json
  risks       Json
  controls    Json
  approvedById String?
  status      AprStatus
  createdAt   DateTime @default(now())
  project     Project @relation(fields: [projectId], references: [id])
  worksite    Worksite? @relation(fields: [worksiteId], references: [id])
  permits     Permit[]
}

model Permit {
  id          String   @id @default(uuid())
  aprId       String
  type        PermitType
  requirements Json
  approvedById String?
  validFrom   DateTime
  validTo     DateTime
  status      PermitStatus
  createdAt   DateTime @default(now())
  apr         Apr @relation(fields: [aprId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  before    Json?
  after     Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([entity])
}
